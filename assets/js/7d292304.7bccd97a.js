"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6480],{6153:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"cache/advanced","title":"Advanced","description":"@cache() Decorator vs Inline Router Config","source":"@site/docs/cache/advanced.md","sourceDirName":"cache","slug":"/cache/advanced","permalink":"/balda/docs/cache/advanced","draft":false,"unlisted":false,"editUrl":"https://github.com/Frasan00/balda/tree/main/docs/docs/cache/advanced.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"docs","previous":{"title":"Invalidation","permalink":"/balda/docs/cache/invalidation"},"next":{"title":"WebSockets","permalink":"/balda/docs/websockets/overview"}}');var t=n(4848),c=n(8453);const i={sidebar_position:5},d="Advanced",l={},o=[{value:"<code>@cache()</code> Decorator vs Inline Router Config",id:"cache-decorator-vs-inline-router-config",level:2},{value:"Response Compression",id:"response-compression",level:2},{value:"Thundering Herd Protection",id:"thundering-herd-protection",level:2},{value:"How it works",id:"how-it-works",level:3},{value:"<code>lockBehavior</code>",id:"lockbehavior",level:3},{value:"Statistics",id:"statistics",level:2}];function a(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"advanced",children:"Advanced"})}),"\n",(0,t.jsxs)(s.h2,{id:"cache-decorator-vs-inline-router-config",children:[(0,t.jsx)(s.code,{children:"@cache()"})," Decorator vs Inline Router Config"]}),"\n",(0,t.jsx)(s.p,{children:"Both approaches are equivalent at runtime. Choose based on your routing style:"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{}),(0,t.jsxs)(s.th,{children:[(0,t.jsx)(s.code,{children:"@cache()"})," decorator"]}),(0,t.jsx)(s.th,{children:"Inline router config"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Used with"}),(0,t.jsx)(s.td,{children:"Controller classes"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"server.router.*()"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:["Type-safe ",(0,t.jsx)(s.code,{children:"include"})," picks"]}),(0,t.jsx)(s.td,{children:"\u274c (no schema access)"}),(0,t.jsx)(s.td,{children:"\u2705 (inferred from schema)"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Tag support"}),(0,t.jsx)(s.td,{children:"\u2705"}),(0,t.jsx)(s.td,{children:"\u2705"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"fromRequest"})}),(0,t.jsx)(s.td,{children:"\u2705"}),(0,t.jsx)(s.td,{children:"\u2705"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Decorator:"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"import { controller, get, cache } from 'balda';\n\n@controller('/api/users')\nclass UserController {\n  @get('/:id')\n  @cache({ ttl: 60, tags: ['users'] })\n  async getUser(req, res) { /* ... */ }\n}\n"})}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Inline:"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"server.router.get(\n  '/api/users/:id',\n  { cache: { ttl: 60, tags: ['users'] } },\n  (req, res) => { /* ... */ },\n);\n"})}),"\n",(0,t.jsx)(s.h2,{id:"response-compression",children:"Response Compression"}),"\n",(0,t.jsx)(s.p,{children:"For large responses, Balda can gzip-compress the serialized JSON before storing it in the cache."}),"\n",(0,t.jsx)(s.p,{children:"Enable it per-route:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"@cache({ ttl: 300, useCompression: true })\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Compression is only applied when the serialized response exceeds ",(0,t.jsx)(s.code,{children:"compressionThreshold"})," (default: 1024 bytes). Smaller responses are stored as-is regardless of the ",(0,t.jsx)(s.code,{children:"useCompression"})," flag."]}),"\n",(0,t.jsx)(s.p,{children:"Configure the threshold globally in server options:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"const server = new Server({\n  cache: {\n    provider: 'redis',\n    compressionThreshold: 2048, // compress responses > 2 KB\n  },\n});\n"})}),"\n",(0,t.jsx)(s.h2,{id:"thundering-herd-protection",children:"Thundering Herd Protection"}),"\n",(0,t.jsx)(s.p,{children:"When many concurrent requests hit a cold cache entry at the same time, only the first request should execute the handler \u2014 the rest should wait for the result. Balda handles this with a distributed lock."}),"\n",(0,t.jsx)(s.h3,{id:"how-it-works",children:"How it works"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"The first request acquires a lock for the cache key."}),"\n",(0,t.jsx)(s.li,{children:"Subsequent requests detect the lock and enter a wait loop (polling every 50 ms)."}),"\n",(0,t.jsx)(s.li,{children:"Once the first request stores the result and releases the lock, waiting requests serve the cached response."}),"\n",(0,t.jsx)(s.li,{children:"If the lock expires before the cache is populated, waiting requests fall through to execute the handler themselves."}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"lockbehavior",children:(0,t.jsx)(s.code,{children:"lockBehavior"})}),"\n",(0,t.jsxs)(s.p,{children:["Control what happens when a lock cannot be acquired via ",(0,t.jsx)(s.code,{children:"lockBehavior"})," (global default) or per-route:"]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Value"}),(0,t.jsx)(s.th,{children:"Behaviour"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"'wait'"})}),(0,t.jsxs)(s.td,{children:["Poll until the cache is populated or ",(0,t.jsx)(s.code,{children:"lockTimeout"})," expires (default)"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"'bypass'"})}),(0,t.jsx)(s.td,{children:"Execute the handler immediately without waiting"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"'fail'"})}),(0,t.jsxs)(s.td,{children:["Return ",(0,t.jsx)(s.code,{children:"503 Service Unavailable"})," immediately"]})]})]})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"// Global default\nconst server = new Server({\n  cache: {\n    provider: 'redis',\n    lockTimeout: 5000,      // ms before lock expires\n    lockBehavior: 'bypass', // fall through instead of waiting\n  },\n});\n\n// Per-route override\n@cache({ ttl: 60, lockBehavior: 'fail' })\n"})}),"\n",(0,t.jsx)(s.h2,{id:"statistics",children:"Statistics"}),"\n",(0,t.jsxs)(s.p,{children:["When ",(0,t.jsx)(s.code,{children:"enableStats: true"})," (the default), Balda tracks cache activity and exposes it via ",(0,t.jsx)(s.code,{children:"server.cache.getStats()"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"const stats = server.cache.getStats();\n// {\n//   hits: 142,\n//   misses: 38,\n//   hitRate: 0.789,\n//   invalidations: 5,\n// }\n\nconsole.log(`Hit rate: ${(stats.hitRate * 100).toFixed(1)}%`);\n"})}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Field"}),(0,t.jsx)(s.th,{children:"Type"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hits"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"number"})}),(0,t.jsx)(s.td,{children:"Total cache hits since server start"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"misses"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"number"})}),(0,t.jsx)(s.td,{children:"Total cache misses since server start"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hitRate"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"number"})}),(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"hits / (hits + misses)"})," (0.0 \u2013 1.0)"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"invalidations"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"number"})}),(0,t.jsx)(s.td,{children:"Total keys deleted via any invalidation method"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:"Disable stats tracking to save a small amount of overhead:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"const server = new Server({\n  cache: { provider: 'memory', enableStats: false },\n});\n"})})]})}function h(e={}){const{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>d});var r=n(6540);const t={},c=r.createContext(t);function i(e){const s=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(c.Provider,{value:s},e.children)}}}]);