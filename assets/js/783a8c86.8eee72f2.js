"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6143],{3691:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"plugins/async-local-storage","title":"Async Local Storage Plugin","description":"Provides a powerful context management system using Node.js AsyncLocalStorage. This plugin allows you to store and access request-scoped data throughout your application without explicitly passing it through function parameters.","source":"@site/docs/plugins/async-local-storage.md","sourceDirName":"plugins","slug":"/plugins/async-local-storage","permalink":"/balda-js/docs/plugins/async-local-storage","draft":false,"unlisted":false,"editUrl":"https://github.com/Frasan00/balda-js/tree/main/docs/docs/plugins/async-local-storage.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docs","previous":{"title":"Log Plugin","permalink":"/balda-js/docs/plugins/log"},"next":{"title":"Swagger Plugin","permalink":"/balda-js/docs/plugins/swagger"}}');var r=t(4848),a=t(8453);const i={sidebar_position:6},o="Async Local Storage Plugin",c={},l=[{value:"Quick Start",id:"quick-start",level:2},{value:"Extending the Context",id:"extending-the-context",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Setter Functions",id:"setter-functions",level:3},{value:"Accessing Context in Routes",id:"accessing-context-in-routes",level:2},{value:"Using req.ctx",id:"using-reqctx",level:3},{value:"Using asyncStorage.getStore()",id:"using-asyncstoragegetstore",level:3},{value:"Context in Services",id:"context-in-services",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Type Safety",id:"type-safety",level:3},{value:"Async Setters",id:"async-setters",level:3},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Request Logging",id:"request-logging",level:3},{value:"Limitations",id:"limitations",level:2},{value:"Related Plugins",id:"related-plugins",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"async-local-storage-plugin",children:"Async Local Storage Plugin"})}),"\n",(0,r.jsx)(n.p,{children:"Provides a powerful context management system using Node.js AsyncLocalStorage. This plugin allows you to store and access request-scoped data throughout your application without explicitly passing it through function parameters."}),"\n",(0,r.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Server, asyncStorage } from 'balda-js';\n\nconst server = new Server({\n  plugins: {\n    asyncLocalStorage: {\n      id: () => Math.random().toString(36).substring(2, 15)\n    }\n  }\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"extending-the-context",children:"Extending the Context"}),"\n",(0,r.jsxs)(n.p,{children:["To add custom properties to the context, extend the ",(0,r.jsx)(n.code,{children:"AsyncLocalStorageContext"})," interface using module augmentation:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'declare module "balda-js" {\n  interface AsyncLocalStorageContext {\n    id: string;\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"This TypeScript declaration ensures type safety when accessing context properties throughout your application."}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.p,{children:"The plugin accepts an object where each key represents a context property, and the value is a setter function that returns the value for that property:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"plugins: {\n  asyncLocalStorage: {\n    id: () => crypto.randomUUID(),\n    userId: (req) => req.headers['x-user-id'],\n    timestamp: () => Date.now(),\n    requestId: () => Math.random().toString(36).substring(2, 15)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"setter-functions",children:"Setter Functions"}),"\n",(0,r.jsx)(n.p,{children:"Setter functions can:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Accept the ",(0,r.jsx)(n.code,{children:"Request"})," object as a parameter"]}),"\n",(0,r.jsx)(n.li,{children:"Return values synchronously or asynchronously"}),"\n",(0,r.jsx)(n.li,{children:"Access request headers, query parameters, or any request data"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"plugins: {\n  asyncLocalStorage: {\n    // Simple value\n    requestId: () => crypto.randomUUID(),\n\n    // From request\n    userId: (req) => req.headers['x-user-id'],\n\n    // Async operation\n    tenant: async (req) => await getTenantFromToken(req.headers.authorization)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"accessing-context-in-routes",children:"Accessing Context in Routes"}),"\n",(0,r.jsx)(n.h3,{id:"using-reqctx",children:"Using req.ctx"}),"\n",(0,r.jsxs)(n.p,{children:["The most common way to access context is through the ",(0,r.jsx)(n.code,{children:"req.ctx"})," property:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'server.get("/async-local-storage", async (req, res) => {\n  // Access context via req.ctx\n  return res.ok({ id: req.ctx.id });\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"using-asyncstoragegetstore",children:"Using asyncStorage.getStore()"}),"\n",(0,r.jsxs)(n.p,{children:["For accessing context outside of route handlers (like in services, utilities, or helper functions), use the ",(0,r.jsx)(n.code,{children:"asyncStorage"})," export:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { asyncStorage } from 'balda-js';\n\nserver.get(\"/async-local-storage\", async (req, res) => {\n  // Access context directly via asyncStorage\n  const ctx = asyncStorage.getStore();\n  console.log(ctx);\n\n  return res.ok({ id: req.ctx.id });\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"context-in-services",children:"Context in Services"}),"\n",(0,r.jsx)(n.p,{children:"Access context in service layers without prop drilling:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// logger.service.ts\nimport { asyncStorage } from 'balda-js';\n\nexport function log(message: string, level: string = 'info') {\n  const ctx = asyncStorage.getStore();\n\n  console.log(JSON.stringify({\n    level,\n    message,\n    requestId: ctx?.requestId,\n    userId: ctx?.userId,\n    timestamp: new Date().toISOString()\n  }));\n}\n\n// user.service.ts\nimport { asyncStorage } from 'balda-js';\nimport { log } from './logger.service';\n\nexport async function createUser(userData: any) {\n  const ctx = asyncStorage.getStore();\n\n  log(`Creating user for tenant ${ctx?.tenantId}`);\n\n  // User creation logic\n  const user = await db.users.create({\n    ...userData,\n    tenantId: ctx?.tenantId,\n    createdBy: ctx?.userId\n  });\n\n  log(`User created: ${user.id}`);\n\n  return user;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"type-safety",children:"Type Safety"}),"\n",(0,r.jsx)(n.p,{children:"Always declare types for your context properties:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'declare module "balda-js" {\n  interface AsyncLocalStorageContext {\n    requestId: string;\n    userId?: string; // Optional properties should be marked\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"async-setters",children:"Async Setters"}),"\n",(0,r.jsx)(n.p,{children:"Use async setters when you need to fetch data:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"asyncLocalStorage: {\n  organizationId: async (req) => {\n    const userId = req.user.id;\n    return await getOrganizationForUser(userId);\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,r.jsx)(n.h3,{id:"request-logging",children:"Request Logging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { asyncStorage } from 'balda-js';\n\nserver.use((req, res, next) => {\n  const ctx = asyncStorage.getStore();\n  console.log(`[${ctx?.requestId}] ${req.method} ${req.url}`);\n  next();\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"limitations",children:"Limitations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Context is only available within the async execution flow of a request"}),"\n",(0,r.jsx)(n.li,{children:"Context is lost when using callbacks or setTimeout without proper binding"}),"\n",(0,r.jsx)(n.li,{children:"Not suitable for sharing data between different requests"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"related-plugins",children:"Related Plugins"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./cookie",children:"Cookie Plugin"})," - For client-side state management"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./log",children:"Log Plugin"})," - Enhanced logging with context support"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var s=t(6540);const r={},a=s.createContext(r);function i(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);