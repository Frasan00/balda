"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5403],{8069:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"core-concepts/streaming","title":"Streaming Responses","description":"Balda.js provides built-in support for streaming responses, enabling real-time data delivery for use cases like Server-Sent Events (SSE), AI chat completions, live feeds, and progressive data loading.","source":"@site/docs/core-concepts/streaming.md","sourceDirName":"core-concepts","slug":"/core-concepts/streaming","permalink":"/balda-js/docs/core-concepts/streaming","draft":false,"unlisted":false,"editUrl":"https://github.com/Frasan00/balda-js/tree/main/docs/docs/core-concepts/streaming.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docs","previous":{"title":"Request & Response","permalink":"/balda-js/docs/core-concepts/request-response"},"next":{"title":"Hashing","permalink":"/balda-js/docs/core-concepts/hashing"}}');var r=s(4848),a=s(8453);const o={sidebar_position:6},i="Streaming Responses",c={},d=[{value:"The <code>stream()</code> Method",id:"the-stream-method",level:2},{value:"Basic Usage with Async Generator",id:"basic-usage-with-async-generator",level:3},{value:"Using Sync Generators",id:"using-sync-generators",level:3},{value:"Using ReadableStream",id:"using-readablestream",level:3},{value:"Custom Content Type",id:"custom-content-type",level:3},{value:"Server-Sent Events (SSE) Format",id:"server-sent-events-sse-format",level:2},{value:"SSE Event Structure",id:"sse-event-structure",level:3},{value:"Real-World Example: AI Chat Streaming",id:"real-world-example-ai-chat-streaming",level:2},{value:"Low-Level: Using <code>nodeResponse</code> Directly",id:"low-level-using-noderesponse-directly",level:2},{value:"When to Use <code>nodeResponse</code>",id:"when-to-use-noderesponse",level:3},{value:"Client-Side Consumption",id:"client-side-consumption",level:2},{value:"JavaScript EventSource",id:"javascript-eventsource",level:3},{value:"Fetch API with ReadableStream",id:"fetch-api-with-readablestream",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Always Close Streams",id:"1-always-close-streams",level:3},{value:"2. Handle Errors Gracefully",id:"2-handle-errors-gracefully",level:3},{value:"3. Consider Connection Timeouts",id:"3-consider-connection-timeouts",level:3},{value:"4. Use Appropriate Content Types",id:"4-use-appropriate-content-types",level:3},{value:"Summary",id:"summary",level:2}];function l(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"streaming-responses",children:"Streaming Responses"})}),"\n",(0,r.jsx)(n.p,{children:"Balda.js provides built-in support for streaming responses, enabling real-time data delivery for use cases like Server-Sent Events (SSE), AI chat completions, live feeds, and progressive data loading."}),"\n",(0,r.jsxs)(n.h2,{id:"the-stream-method",children:["The ",(0,r.jsx)(n.code,{children:"stream()"})," Method"]}),"\n",(0,r.jsxs)(n.p,{children:["The recommended way to stream responses is using the ",(0,r.jsx)(n.code,{children:"stream()"})," method on the Response object. It accepts async generators, sync generators, or ",(0,r.jsx)(n.code,{children:"ReadableStream"})," objects."]}),"\n",(0,r.jsx)(n.h3,{id:"basic-usage-with-async-generator",children:"Basic Usage with Async Generator"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'import { Server } from \'balda-js\';\n\nconst server = new Server({ port: 3000 });\n\nasync function* generateData() {\n  yield "data: First chunk\\n\\n";\n  await new Promise(resolve => setTimeout(resolve, 1000));\n  yield "data: Second chunk\\n\\n";\n  await new Promise(resolve => setTimeout(resolve, 1000));\n  yield "data: Third chunk\\n\\n";\n}\n\nserver.get(\'/stream\', async (req, res) => {\n  res.stream(generateData());\n});\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"stream()"})," method automatically sets the following headers for Server-Sent Events:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"Content-Type: text/event-stream"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"Cache-Control: no-cache"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"Connection: keep-alive"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"using-sync-generators",children:"Using Sync Generators"}),"\n",(0,r.jsx)(n.p,{children:"For simpler cases where you don't need async operations:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'function* generateChunks() {\n  yield "data: Hello\\n\\n";\n  yield "data: World\\n\\n";\n  yield "data: Done\\n\\n";\n}\n\nserver.get(\'/sync-stream\', async (req, res) => {\n  res.stream(generateChunks());\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"using-readablestream",children:"Using ReadableStream"}),"\n",(0,r.jsxs)(n.p,{children:["You can also pass a ",(0,r.jsx)(n.code,{children:"ReadableStream"})," directly:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'function createStream() {\n  return new ReadableStream({\n    start(controller) {\n      controller.enqueue("data: First\\n\\n");\n      controller.enqueue("data: Second\\n\\n");\n      controller.enqueue("data: Third\\n\\n");\n      controller.close(); // Important: close the stream when done\n    }\n  });\n}\n\nserver.get(\'/readable-stream\', async (req, res) => {\n  res.stream(createStream());\n});\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["When using ",(0,r.jsx)(n.code,{children:"ReadableStream"}),", always call ",(0,r.jsx)(n.code,{children:"controller.close()"})," when finished. Failing to close the stream will cause the connection to hang indefinitely."]})}),"\n",(0,r.jsx)(n.h3,{id:"custom-content-type",children:"Custom Content Type"}),"\n",(0,r.jsxs)(n.p,{children:["By default, ",(0,r.jsx)(n.code,{children:"stream()"})," uses ",(0,r.jsx)(n.code,{children:"text/event-stream"}),". You can override this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"server.get('/custom-stream', async (req, res) => {\n  res.stream(generateData(), { contentType: 'text/plain' });\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"server-sent-events-sse-format",children:"Server-Sent Events (SSE) Format"}),"\n",(0,r.jsx)(n.p,{children:"For proper SSE implementation, format your data according to the SSE specification:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'async function* sseGenerator() {\n  // Basic message\n  yield "data: Hello World\\n\\n";\n\n  // Message with event type\n  yield "event: update\\ndata: {\\"status\\": \\"processing\\"}\\n\\n";\n\n  // Message with ID (for reconnection)\n  yield "id: 1\\ndata: First event\\n\\n";\n\n  // Multi-line data\n  yield "data: Line 1\\ndata: Line 2\\n\\n";\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"sse-event-structure",children:"SSE Event Structure"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Field"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"data:"})}),(0,r.jsx)(n.td,{children:"The message payload (required)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"event:"})}),(0,r.jsx)(n.td,{children:'Custom event type (optional, default is "message")'})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"id:"})}),(0,r.jsx)(n.td,{children:"Event ID for client reconnection (optional)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"retry:"})}),(0,r.jsx)(n.td,{children:"Reconnection time in milliseconds (optional)"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Each message must end with ",(0,r.jsx)(n.code,{children:"\\n\\n"})," (double newline)."]}),"\n",(0,r.jsx)(n.h2,{id:"real-world-example-ai-chat-streaming",children:"Real-World Example: AI Chat Streaming"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Server } from 'balda-js';\nimport OpenAI from 'openai';\n\nconst server = new Server({ port: 3000 });\nconst openai = new OpenAI();\n\nasync function* streamChatCompletion(messages: any[]) {\n  const stream = await openai.chat.completions.create({\n    model: 'gpt-4',\n    messages,\n    stream: true\n  });\n\n  for await (const chunk of stream) {\n    const content = chunk.choices[0]?.delta?.content;\n    if (content) {\n      yield `data: ${JSON.stringify({ content })}\\n\\n`;\n    }\n  }\n\n  yield \"data: [DONE]\\n\\n\";\n}\n\nserver.post('/chat', async (req, res) => {\n  const { messages } = req.body;\n  res.stream(streamChatCompletion(messages));\n});\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"low-level-using-noderesponse-directly",children:["Low-Level: Using ",(0,r.jsx)(n.code,{children:"nodeResponse"})," Directly"]}),"\n",(0,r.jsxs)(n.p,{children:["For advanced use cases requiring fine-grained control, you can access the underlying Node.js response object directly via ",(0,r.jsx)(n.code,{children:"res.nodeResponse"}),"."]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["This approach is only available when running on Node.js runtime. The ",(0,r.jsx)(n.code,{children:"nodeResponse"})," property is ",(0,r.jsx)(n.code,{children:"undefined"})," on other runtimes (Deno, Bun) that use Web API Response objects."]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"server.get('/node-stream', async (req, res) => {\n  // Set headers manually\n  res.nodeResponse.setHeader('Content-Type', 'text/event-stream');\n  res.nodeResponse.setHeader('Cache-Control', 'no-cache');\n  res.nodeResponse.setHeader('Connection', 'keep-alive');\n  res.nodeResponse.flushHeaders();\n\n  try {\n    for await (const chunk of generateData()) {\n      res.nodeResponse.write(chunk);\n    }\n  } finally {\n    res.nodeResponse.end();\n  }\n});\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"when-to-use-noderesponse",children:["When to Use ",(0,r.jsx)(n.code,{children:"nodeResponse"})]}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"nodeResponse"})," when you need:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Custom write timing or batching"}),"\n",(0,r.jsx)(n.li,{children:"Manual backpressure handling"}),"\n",(0,r.jsx)(n.li,{children:"Integration with Node.js streams"}),"\n",(0,r.jsx)(n.li,{children:"Direct access to Node.js response methods"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"client-side-consumption",children:"Client-Side Consumption"}),"\n",(0,r.jsx)(n.h3,{id:"javascript-eventsource",children:"JavaScript EventSource"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const eventSource = new EventSource('/stream');\n\neventSource.onmessage = (event) => {\n  console.log('Received:', event.data);\n};\n\neventSource.onerror = (error) => {\n  console.error('Error:', error);\n  eventSource.close();\n};\n\n// Custom event types\neventSource.addEventListener('update', (event) => {\n  console.log('Update event:', event.data);\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"fetch-api-with-readablestream",children:"Fetch API with ReadableStream"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"async function consumeStream() {\n  const response = await fetch('/stream');\n  const reader = response.body.getReader();\n  const decoder = new TextDecoder();\n\n  while (true) {\n    const { done, value } = await reader.read();\n    if (done) break;\n\n    const chunk = decoder.decode(value);\n    console.log('Chunk:', chunk);\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"1-always-close-streams",children:"1. Always Close Streams"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'// \u2705 Good: Stream closes when generator completes\nasync function* goodGenerator() {\n  yield "data: start\\n\\n";\n  yield "data: end\\n\\n";\n  // Generator naturally completes\n}\n\n// \u2705 Good: Explicit close for ReadableStream\nnew ReadableStream({\n  start(controller) {\n    controller.enqueue("data: hello\\n\\n");\n    controller.close(); // Don\'t forget this!\n  }\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"2-handle-errors-gracefully",children:"2. Handle Errors Gracefully"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"async function* safeGenerator() {\n  try {\n    yield \"data: starting\\n\\n\";\n\n    const data = await fetchData();\n    yield `data: ${JSON.stringify(data)}\\n\\n`;\n\n  } catch (error) {\n    yield `data: ${JSON.stringify({ error: 'Failed to fetch data' })}\\n\\n`;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-consider-connection-timeouts",children:"3. Consider Connection Timeouts"}),"\n",(0,r.jsx)(n.p,{children:"For long-running streams, send periodic heartbeats to prevent proxy timeouts:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'async function* withHeartbeat() {\n  const heartbeatInterval = setInterval(() => {\n    // Comment lines are ignored by EventSource\n  }, 15000);\n\n  try {\n    yield ": heartbeat\\n\\n"; // SSE comment for keepalive\n\n    for await (const data of dataSource) {\n      yield `data: ${JSON.stringify(data)}\\n\\n`;\n    }\n  } finally {\n    clearInterval(heartbeatInterval);\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"4-use-appropriate-content-types",children:"4. Use Appropriate Content Types"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Use Case"}),(0,r.jsx)(n.th,{children:"Content Type"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Server-Sent Events"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"text/event-stream"})," (default)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Plain text streaming"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"text/plain"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"JSON streaming (NDJSON)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"application/x-ndjson"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Binary data"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"application/octet-stream"})})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Approach"}),(0,r.jsx)(n.th,{children:"Use Case"}),(0,r.jsx)(n.th,{children:"Cross-Runtime"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"res.stream(generator)"})}),(0,r.jsx)(n.td,{children:"Most streaming scenarios"}),(0,r.jsx)(n.td,{children:"\u2705 Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"res.stream(ReadableStream)"})}),(0,r.jsx)(n.td,{children:"When you have a ReadableStream"}),(0,r.jsx)(n.td,{children:"\u2705 Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"res.nodeResponse"})}),(0,r.jsx)(n.td,{children:"Low-level Node.js control"}),(0,r.jsx)(n.td,{children:"\u274c Node.js only"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"stream()"})," method is the recommended approach for most use cases as it provides a clean API and works across all supported runtimes."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>i});var t=s(6540);const r={},a=t.createContext(r);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);