import { existsSync, mkdirSync, writeFileSync } from "fs";
import { join } from "path";
import type { BenchmarkResult } from "./runner.js";

export interface BenchmarkReport {
  timestamp: string;
  runtime: string;
  nodeVersion: string;
  platform: string;
  arch: string;
  results: BenchmarkResult[];
}

export const saveResults = (
  results: BenchmarkResult[],
  outputDir: string,
): void => {
  if (!existsSync(outputDir)) {
    mkdirSync(outputDir, { recursive: true });
  }

  const report: BenchmarkReport = {
    timestamp: new Date().toISOString(),
    runtime: results[0]?.runtime || "unknown",
    nodeVersion: process.version || "N/A",
    platform: process.platform,
    arch: process.arch,
    results,
  };

  const jsonPath = join(outputDir, "results.json");
  writeFileSync(jsonPath, JSON.stringify(report, null, 2));

  const markdownPath = join(outputDir, "REPORT.md");
  writeFileSync(markdownPath, generateMarkdownReport(report));

  console.log(`\nâœ“ Results saved to:`);
  console.log(`  - ${jsonPath}`);
  console.log(`  - ${markdownPath}`);
};

const generateMarkdownReport = (report: BenchmarkReport): string => {
  const { timestamp, runtime, nodeVersion, platform, arch, results } = report;

  let markdown = `# Balda Framework Benchmark Report

**Generated:** ${timestamp}
**Runtime:** ${runtime}
**Node Version:** ${nodeVersion}
**Platform:** ${platform}
**Architecture:** ${arch}

## Summary

`;

  if (results.length === 0) {
    markdown += "No results available.\n";
    return markdown;
  }

  const avgReqsPerSec =
    results.reduce((sum, r) => sum + r.requestsPerSec, 0) / results.length;
  const avgLatency =
    results.reduce((sum, r) => sum + r.latencyAvg, 0) / results.length;
  const avgP99 =
    results.reduce((sum, r) => sum + r.latencyP99, 0) / results.length;
  const totalRequests = results.reduce((sum, r) => sum + r.requestsTotal, 0);
  const totalErrors = results.reduce((sum, r) => sum + r.errors, 0);

  markdown += `| Metric | Value |
|--------|-------|
| Average Requests/sec | ${avgReqsPerSec.toFixed(2)} |
| Average Latency | ${avgLatency.toFixed(2)} ms |
| Average P99 Latency | ${avgP99.toFixed(2)} ms |
| Total Requests | ${totalRequests.toLocaleString()} |
| Total Errors | ${totalErrors} |
| Error Rate | ${((totalErrors / totalRequests) * 100).toFixed(4)}% |

## Detailed Results

`;

  markdown += `| Scenario | Req/sec | Latency (ms) | P50 (ms) | P95 (ms) | P99 (ms) | Throughput (MB/s) | Errors |
|----------|---------|--------------|----------|----------|----------|-------------------|--------|
`;

  results.forEach((result) => {
    markdown += `| ${result.scenario} | ${result.requestsPerSec.toFixed(2)} | ${result.latencyAvg.toFixed(2)} | ${result.latencyP50.toFixed(2)} | ${result.latencyP95.toFixed(2)} | ${result.latencyP99.toFixed(2)} | ${result.throughputMB.toFixed(2)} | ${result.errors} |
`;
  });

  markdown += `
## Performance Analysis

### Best Performing Scenarios

`;

  const sortedByReqs = [...results].sort(
    (a, b) => b.requestsPerSec - a.requestsPerSec,
  );
  markdown += `**Highest Throughput:**
1. ${sortedByReqs[0].scenario} - ${sortedByReqs[0].requestsPerSec.toFixed(2)} req/sec
2. ${sortedByReqs[1]?.scenario || "N/A"} - ${sortedByReqs[1]?.requestsPerSec.toFixed(2) || "N/A"} req/sec
3. ${sortedByReqs[2]?.scenario || "N/A"} - ${sortedByReqs[2]?.requestsPerSec.toFixed(2) || "N/A"} req/sec

`;

  const sortedByLatency = [...results].sort(
    (a, b) => a.latencyAvg - b.latencyAvg,
  );
  markdown += `**Lowest Latency:**
1. ${sortedByLatency[0].scenario} - ${sortedByLatency[0].latencyAvg.toFixed(2)} ms
2. ${sortedByLatency[1]?.scenario || "N/A"} - ${sortedByLatency[1]?.latencyAvg.toFixed(2) || "N/A"} ms
3. ${sortedByLatency[2]?.scenario || "N/A"} - ${sortedByLatency[2]?.latencyAvg.toFixed(2) || "N/A"} ms

`;

  markdown += `## Configuration

All benchmarks were run with the following standardized configuration:
- **Connections:** 100
- **Duration:** 40 seconds
- **Pipelining:** 10

This ensures results are machine-independent and reproducible across different environments.

---

*Generated by Balda Benchmark Suite*
`;

  return markdown;
};
